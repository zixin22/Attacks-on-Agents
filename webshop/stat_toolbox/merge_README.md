# merge.py User Guide

## ğŸ“‹ Overview

`merge.py` is a tool for merging multiple `_reward_analysis.txt` files. It extracts all fixed numbers with "Reward" >= 0.5 from multiple analysis files, merges, deduplicates, and sorts them, then saves to a JSON file.

## ğŸ¯ Features

1. **Parse multiple analysis files**: Extract fixed numbers from multiple `_reward_analysis.txt` files
2. **Merge and deduplicate**: Automatically merge all numbers and remove duplicates
3. **Sort**: Sort the merged number list
4. **Save results**: Save in both JSON format and simple text format

## ğŸ“¦ Dependencies

- Python 3.6+
- Standard libraries: `json`, `sys`, `os`, `re`

## ğŸš€ Usage

### Basic Usage

```bash
python merge.py <output_file.json> <input_file1.txt> <input_file2.txt> ...
```

### Parameters

- `<output_file.json>`: Output JSON file path (required)
  - Example: `merged_reward_ge_05.json`
  
- `<input_file1.txt> <input_file2.txt> ...`: One or more input file paths (required)
  - These should be `_reward_analysis.txt` files generated by `reward_cont.py`
  - Multiple files can be specified

### Examples

#### Example 1: Merge two analysis files

```bash
python merge.py merged_reward_ge_05.json \
    ../output_0_500/memory_1_reward_analysis.txt \
    ../output_501_1000/memory_1_reward_analysis.txt
```

#### Example 2: Merge multiple analysis files (Windows PowerShell)

```powershell
python merge.py merged_reward_ge_05.json `
    ../output_0_500/memory_1_reward_analysis.txt `
    ../output_501_1000/memory_1_reward_analysis.txt `
    ../output_1001_1500/memory_1_reward_analysis.txt `
    ../output_1501_2000/memory_1_reward_analysis.txt
```

#### Example 3: Using absolute paths

```bash
python merge.py C:\Users\22749\Desktop\rap-main\merged_reward_ge_05.json \
    C:\Users\22749\Desktop\rap-main\webshop\output_0_500\memory_1_reward_analysis.txt \
    C:\Users\22749\Desktop\rap-main\webshop\output_501_1000\memory_1_reward_analysis.txt
```

## ğŸ“Š Output

### Console Output

The program displays processing progress and results:

```
============================================================
åˆå¹¶ Reward >= 0.5 çš„ fixed åºå·
============================================================
è¾“å…¥æ–‡ä»¶æ•°é‡: 3
è¾“å‡ºæ–‡ä»¶: merged_reward_ge_05.json

æ­£åœ¨å¤„ç†: ../output_0_500/memory_1_reward_analysis.txt
  æå–äº† 45 ä¸ªåºå·
æ­£åœ¨å¤„ç†: ../output_501_1000/memory_1_reward_analysis.txt
  æå–äº† 38 ä¸ªåºå·
æ­£åœ¨å¤„ç†: ../output_1001_1500/memory_1_reward_analysis.txt
  æå–äº† 42 ä¸ªåºå·

============================================================
åˆå¹¶ç»“æœ:
  æ€»åºå·æ•°é‡: 79
  åºå·èŒƒå›´: 0 - 498
============================================================

ç»“æœå·²ä¿å­˜åˆ°: merged_reward_ge_05.json
ç®€å•åˆ—è¡¨æ ¼å¼å·²ä¿å­˜åˆ°: merged_reward_ge_05_simple.txt
```

### Output Files

The program generates two output files:

#### 1. JSON Format File (`<output_file>.json`)

Contains complete metadata and number list:

```json
{
  "description": "åˆå¹¶çš„ Reward >= 0.5 çš„ fixed åºå·",
  "source_files": [
    "../output_0_500/memory_1_reward_analysis.txt",
    "../output_501_1000/memory_1_reward_analysis.txt",
    "../output_1001_1500/memory_1_reward_analysis.txt"
  ],
  "total_count": 79,
  "fixed_numbers": [
    0,
    7,
    29,
    35,
    37,
    ...
  ]
}
```

**Field descriptions**:
- `description`: File description
- `source_files`: List of source files
- `total_count`: Total count of merged numbers
- `fixed_numbers`: Merged, deduplicated, and sorted number list

#### 2. Simple Text Format File (`<output_file>_simple.txt`)

Contains a simple number list:

```
åˆå¹¶çš„ Reward >= 0.5 çš„ fixed åºå· (å…± 79 ä¸ª):
[0, 7, 29, 35, 37, 38, 39, 43, 46, 48, 49, 53, 68, 77, ...]
```

## ğŸ” How It Works

1. **Parse input files**: 
   - Reads each `_reward_analysis.txt` file
   - Finds the line containing "Reward' >= 0.5"
   - Extracts the number list from the next line (format: `[0, 7, 29, ...]`)

2. **Extract numbers**: 
   - Uses regular expressions to extract all numbers from the list string
   - Converts to integer list

3. **Merge and deduplicate**: 
   - Adds all numbers from all files to a set (automatic deduplication)
   - Converts to sorted list

4. **Save results**: 
   - Saves as JSON format (with metadata)
   - Saves as simple text format (number list only)

## âš ï¸ Notes

1. **Input file format**: 
   - Input files must be in `_reward_analysis.txt` format generated by `reward_cont.py`
   - Files must contain a line with "Reward' >= 0.5" and the next line should be the number list

2. **File paths**: 
   - Supports both relative and absolute paths
   - Windows paths can use either backslash `\` or forward slash `/`

3. **Deduplication**: 
   - If multiple files contain the same fixed number, only one will be kept
   - Final list is a sorted unique number list

4. **Output directory**: 
   - Output files are saved in the current working directory or specified absolute path
   - Ensure write permissions

## ğŸ› Common Errors

### Error 1: File not found

```
é”™è¯¯: å¤„ç†æ–‡ä»¶ ../output_0_500/memory_1_reward_analysis.txt æ—¶å‡ºé”™: æ–‡ä»¶ä¸å­˜åœ¨: ../output_0_500/memory_1_reward_analysis.txt
```

**Solution**: Check if file paths are correct and files exist

### Error 2: Incorrect file format

```
è­¦å‘Š: åœ¨æ–‡ä»¶ xxx.txt ä¸­æœªæ‰¾åˆ° 'Reward' >= 0.5 çš„è¡Œ
```

**Solution**: Ensure input files are analysis files generated by `reward_cont.py`

### Error 3: Cannot parse number list

```
è­¦å‘Š: æ— æ³•ä»æ–‡ä»¶ xxx.txt ä¸­è§£æåºå·åˆ—è¡¨
```

**Solution**: Check file format, ensure number list format is correct (`[0, 7, 29, ...]`)

### Error 4: Insufficient parameters

```
ç”¨æ³•: python merge.py <output_file.json> <input_file1.txt> <input_file2.txt> ...
```

**Solution**: At least provide output file path and one input file path

## ğŸ“š Related Tools

- **reward_cont.py**: Generates `_reward_analysis.txt` analysis files
- See `reward_cont_README.md` for detailed usage

## ğŸ’¡ Use Cases

1. **Merge multiple trial results**: Merge analysis results from different output directories
2. **Build complete dataset**: Extract all high-quality samples from multiple data ranges
3. **Data statistics**: Statistics on total sample counts and distributions across multiple trials
4. **Dataset preparation**: Prepare fixed number lists for subsequent dataset construction

## ğŸ”— Complete Workflow Example

### Step 1: Analyze multiple memory files

```bash
# Analyze memory files from different ranges
python reward_cont.py ../output_0_500/memory_1.json
python reward_cont.py ../output_501_1000/memory_1.json
python reward_cont.py ../output_1001_1500/memory_1.json
```

### Step 2: Merge analysis results

```bash
python merge.py merged_reward_ge_05.json \
    ../output_0_500/memory_1_reward_analysis.txt \
    ../output_501_1000/memory_1_reward_analysis.txt \
    ../output_1001_1500/memory_1_reward_analysis.txt
```

### Step 3: Use merged results

The generated `merged_reward_ge_05.json` file can be used for:
- Building new training datasets
- Further data analysis
- Filtering high-quality samples

## ğŸ“ Output File Usage Example

The merged JSON file can be directly used in other scripts:

```python
import json

# Read merged results
with open('merged_reward_ge_05.json', 'r') as f:
    data = json.load(f)

# Get fixed number list
fixed_numbers = data['fixed_numbers']
print(f"Total high-quality samples: {len(fixed_numbers)}")
print(f"Number range: {min(fixed_numbers)} - {max(fixed_numbers)}")
```
